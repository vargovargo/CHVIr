data = plot.data,
x = ~ round(Participants / 1000000,1),
y = ~ round(Injuries / 1000,1),
type = "scatter",
mode = "markers",
text = plot.data[["Year"]],
color = ~AgeGroup,
showlegend = TRUE
) %>%
add_lines(y = ~fitted(loess(Participants / 1000000 ~ Injuries / 1000)),
line = list(color = 'rgba(7, 164, 181, 1)'),
name = "Loess Smoother") %>%
layout(
title = "Cyclist Injuries and Participation by Age",
xaxis = list(
title = "Millions of Participants",
autotick = TRUE,
ticks = "outside",
tick0 = 0,
dtick = 1,
ticklen = 5,
tickwidth = 2,
tickcolor = toRGB("black")
),
yaxis = list(
title = "Thousands of Injuries",
autotick = TRUE,
ticks = "outside",
tick0 = 0,
dtick = 1,
ticklen = 5,
tickwidth = 2,
tickcolor = toRGB("black")
))  %>%
config(
collaborate = FALSE,
displaylogo = FALSE,
modeBarButtonsToRemove = list(
'toggleSpikelines',
'sendDataToCloud',
'hoverCompareCartesian',
'zoom2d',
'pan2d',
'select2d',
'lasso2d',
'zoomIn2d',
'zoomOut2d',
'autoScale2d',
'resetScale2d',
'hoverClosestCartesian'
))
plot_ly(
data = plot.data,
x = ~ round(Participants / 1000000,1),
y = ~ round(Injuries / 1000,1),
type = "scatter",
mode = "markers",
text = plot.data[["Year"]],
color = ~AgeGroup,
showlegend = TRUE
) %>%
add_lines(y = ~fitted(loess(Participants/1000000 ~ Injuries/1000)),
line = list(color = 'rgba(7, 164, 181, 1)'),
name = "Loess Smoother") %>%
layout(
title = "Cyclist Injuries and Participation by Age",
xaxis = list(
title = "Millions of Participants",
autotick = TRUE,
ticks = "outside",
tick0 = 0,
dtick = 1,
ticklen = 5,
tickwidth = 2,
tickcolor = toRGB("black")
),
yaxis = list(
title = "Thousands of Injuries",
autotick = TRUE,
ticks = "outside",
tick0 = 0,
dtick = 1,
ticklen = 5,
tickwidth = 2,
tickcolor = toRGB("black")
))  %>%
config(
collaborate = FALSE,
displaylogo = FALSE,
modeBarButtonsToRemove = list(
'toggleSpikelines',
'sendDataToCloud',
'hoverCompareCartesian',
'zoom2d',
'pan2d',
'select2d',
'lasso2d',
'zoomIn2d',
'zoomOut2d',
'autoScale2d',
'resetScale2d',
'hoverClosestCartesian'
))
plot_ly(
data = plot.data,
x = ~ round(Participants / 1000000,1),
y = ~ round(Injuries / 1000,1),
type = "scatter",
mode = "markers",
text = plot.data[["Year"]],
color = ~AgeGroup,
showlegend = TRUE
) %>%
add_lines(y = ~fitted(loess(Injuries/1000 ~Participants/1000000)),
line = list(color = 'rgba(7, 164, 181, 1)'),
name = "Loess Smoother") %>%
layout(
title = "Cyclist Injuries and Participation by Age",
xaxis = list(
title = "Millions of Participants",
autotick = TRUE,
ticks = "outside",
tick0 = 0,
dtick = 1,
ticklen = 5,
tickwidth = 2,
tickcolor = toRGB("black")
),
yaxis = list(
title = "Thousands of Injuries",
autotick = TRUE,
ticks = "outside",
tick0 = 0,
dtick = 1,
ticklen = 5,
tickwidth = 2,
tickcolor = toRGB("black")
))  %>%
config(
collaborate = FALSE,
displaylogo = FALSE,
modeBarButtonsToRemove = list(
'toggleSpikelines',
'sendDataToCloud',
'hoverCompareCartesian',
'zoom2d',
'pan2d',
'select2d',
'lasso2d',
'zoomIn2d',
'zoomOut2d',
'autoScale2d',
'resetScale2d',
'hoverClosestCartesian'
))
plot_ly(
data = plot.data,
x = ~ round(Participants / 1000000,1),
y = ~ round(Injuries / 1000,1),
type = "scatter",
mode = "markers",
text = plot.data[["Year"]],
color = ~AgeGroup,
showlegend = TRUE
) %>%
layout(
title = "Cyclist Injuries and Participation by Age",
xaxis = list(
title = "Millions of Participants",
autotick = TRUE,
ticks = "outside",
tick0 = 0,
dtick = 1,
ticklen = 5,
tickwidth = 2,
tickcolor = toRGB("black")
),
yaxis = list(
title = "Thousands of Injuries",
autotick = TRUE,
ticks = "outside",
tick0 = 0,
dtick = 1,
ticklen = 5,
tickwidth = 2,
tickcolor = toRGB("black")
))  %>%
config(
collaborate = FALSE,
displaylogo = FALSE,
modeBarButtonsToRemove = list(
'toggleSpikelines',
'sendDataToCloud',
'hoverCompareCartesian',
'zoom2d',
'pan2d',
'select2d',
'lasso2d',
'zoomIn2d',
'zoomOut2d',
'autoScale2d',
'resetScale2d',
'hoverClosestCartesian'
))
shiny::runApp('UCSDwestNile/WNVsuitability')
library(tidyverse)
library(tidyverse)
library(DT)
library(foreign)
library(plotly)
foo <- read.dta("~/Wildfires_kurt/race eth of asthma ED visits by zip day_exp merged.dta") %>%
mutate(wildfire = ifelse(pm_25 > 0, "WFperiod", "nonWFperiod"),
total = white + hispanic + black + native_am + asian_pi + other + missing) %>%
rename(zip = bene_addr_zip)
foo %>% ggplot() +
geom_point(aes(x=svc_from_dt, y=factor(zip), color=pm_25, alpha=pm_25)) +
scale_color_gradient(low = "white", high = "red") + xlab("Date") + ylab("Zip Code") + scale_alpha_continuous(range = c(.5,1))
foo %>%
group_by(zip, wildfire) %>%
summarise(white = sum(white),
hispanic = sum(hispanic),
black = sum(black),
native_am = sum(native_am),
asian_pi = sum(asian_pi),
other = sum(other),
days = length(svc_from_dt)) %>%
gather(white, hispanic, black, native_am, asian_pi,other, key = race, value = cases) %>%
mutate(cases = ifelse(cases == 0, constant, cases),
casesPerDay = cases/days) %>%
select(zip, wildfire, casesPerDay, race) %>%
spread(key = wildfire, value = casesPerDay)
constant <- 0.1
foo %>%
group_by(zip, wildfire) %>%
summarise(white = sum(white),
hispanic = sum(hispanic),
black = sum(black),
native_am = sum(native_am),
asian_pi = sum(asian_pi),
other = sum(other),
days = length(svc_from_dt)) %>%
gather(white, hispanic, black, native_am, asian_pi,other, key = race, value = cases) %>%
mutate(cases = ifelse(cases == 0, constant, cases),
casesPerDay = cases/days) %>%
select(zip, wildfire, casesPerDay, race) %>%
spread(key = wildfire, value = casesPerDay)
foo %>%
group_by(zip, wildfire) %>%
summarise(white = sum(white),
hispanic = sum(hispanic),
black = sum(black),
native_am = sum(native_am),
asian_pi = sum(asian_pi),
other = sum(other),
days = length(svc_from_dt)) %>%
gather(white, hispanic, black, native_am, asian_pi,other, key = race, value = cases) %>%
mutate(cases = ifelse(cases == 0, constant, cases),
casesPerDay = cases/days)
foo %>%
group_by(zip, wildfire) %>%
summarise(white = sum(white),
hispanic = sum(hispanic),
black = sum(black),
native_am = sum(native_am),
asian_pi = sum(asian_pi),
other = sum(other),
days = length(svc_from_dt)) %>%
gather(white, hispanic, black, native_am, asian_pi,other, key = race, value = cases) %>%
mutate(cases = ifelse(cases == 0, constant, cases),
casesPerDay = cases/days) %>%
# select(zip, wildfire, casesPerDay, race) %>%
spread(key = wildfire, value = casesPerDay)
foo %>%
group_by(zip, wildfire) %>%
summarise(white = sum(white),
hispanic = sum(hispanic),
black = sum(black),
native_am = sum(native_am),
asian_pi = sum(asian_pi),
other = sum(other),
days = length(svc_from_dt)) %>%
gather(white, hispanic, black, native_am, asian_pi,other, key = race, value = cases) %>%
mutate(cases = ifelse(cases == 0, constant, cases),
casesPerDay = cases/days) %>%
select(-days) %>%
spread(key = wildfire, value = casesPerDay)
RR_race <- foo %>%
group_by(zip, wildfire) %>%
summarise(white = sum(white),
hispanic = sum(hispanic),
black = sum(black),
native_am = sum(native_am),
asian_pi = sum(asian_pi),
other = sum(other),
days = length(svc_from_dt)) %>%
gather(white, hispanic, black, native_am, asian_pi,other, key = race, value = cases) %>%
mutate(cases = ifelse(cases == 0, constant, cases),
casesPerDay = cases/days) %>%
select(-days) %>%
spread(key = wildfire, value = cases) %>%
mutate(RateRatio = WFperiod/nonWFperiod,
ln_RateRatio = log(WFperiod/nonWFperiod),
ifelse())
foo %>%
group_by(zip, wildfire) %>%
summarise(white = sum(white),
hispanic = sum(hispanic),
black = sum(black),
native_am = sum(native_am),
asian_pi = sum(asian_pi),
other = sum(other),
days = length(svc_from_dt)) %>%
gather(white, hispanic, black, native_am, asian_pi,other, key = race, value = cases) %>%
mutate(cases = ifelse(cases == 0, constant, cases),
casesPerDay = cases/days) %>%
select(-days) %>%
spread(key = wildfire, value = cases)
foo %>%
group_by(zip, wildfire) %>%
summarise(white = sum(white),
hispanic = sum(hispanic),
black = sum(black),
native_am = sum(native_am),
asian_pi = sum(asian_pi),
other = sum(other),
days = length(svc_from_dt)) %>%
gather(white, hispanic, black, native_am, asian_pi,other, key = race, value = cases)
cases <- foo %>%
group_by(zip, wildfire) %>%
summarise(white = sum(white),
hispanic = sum(hispanic),
black = sum(black),
native_am = sum(native_am),
asian_pi = sum(asian_pi),
other = sum(other),
days = length(svc_from_dt)) %>%
gather(white, hispanic, black, native_am, asian_pi,other, key = race, value = cases) %>%
mutate(cases = ifelse(cases == 0, constant, cases))
foo %>%
group_by(zip, wildfire) %>%
summarise(white = sum(white),
hispanic = sum(hispanic),
black = sum(black),
native_am = sum(native_am),
asian_pi = sum(asian_pi),
other = sum(other),
days = length(svc_from_dt)) %>%
gather(white, hispanic, black, native_am, asian_pi,other, key = race, value = cases) %>%
mutate(cases = ifelse(cases == 0, constant, cases))
cases <- foo %>%
group_by(zip, wildfire) %>%
summarise(white = sum(white),
hispanic = sum(hispanic),
black = sum(black),
native_am = sum(native_am),
asian_pi = sum(asian_pi),
other = sum(other),
days = length(svc_from_dt)) %>%
gather(white, hispanic, black, native_am, asian_pi,other, key = race, value = cases) %>%
mutate(cases = ifelse(cases == 0, constant, cases)) %>%
select(-days) %>%
spread(key = wildfire, value = casesPerDay)
cases <- foo %>%
group_by(zip, wildfire) %>%
summarise(white = sum(white),
hispanic = sum(hispanic),
black = sum(black),
native_am = sum(native_am),
asian_pi = sum(asian_pi),
other = sum(other),
days = length(svc_from_dt)) %>%
gather(white, hispanic, black, native_am, asian_pi,other, key = race, value = cases) %>%
mutate(cases = ifelse(cases == 0, constant, cases)) %>%
select(-days) %>%
spread(key = wildfire, value = cases)
foo %>%
group_by(zip, wildfire) %>%
summarise(white = sum(white),
hispanic = sum(hispanic),
black = sum(black),
native_am = sum(native_am),
asian_pi = sum(asian_pi),
other = sum(other),
days = length(svc_from_dt)) %>%
gather(white, hispanic, black, native_am, asian_pi,other, key = race, value = cases) %>%
mutate(cases = ifelse(cases == 0, constant, cases)) %>%
select(-days) %>%
spread(key = wildfire, value = cases)
foo %>%
group_by(zip, wildfire) %>%
summarise(white = sum(white),
hispanic = sum(hispanic),
black = sum(black),
native_am = sum(native_am),
asian_pi = sum(asian_pi),
other = sum(other),
days = length(svc_from_dt)) %>%
gather(white, hispanic, black, native_am, asian_pi,other, key = race, value = cases) %>%
mutate(cases = ifelse(cases == 0, constant, cases)) %>%
select(-days) %>%
spread(key = wildfire, value = cases)
cases <- foo %>%
group_by(zip, wildfire) %>%
summarise(white = sum(white),
hispanic = sum(hispanic),
black = sum(black),
native_am = sum(native_am),
asian_pi = sum(asian_pi),
other = sum(other),
days = length(svc_from_dt)) %>%
gather(white, hispanic, black, native_am, asian_pi,other, key = race, value = cases) %>%
mutate(cases = ifelse(cases == 0, constant, cases)) %>%
select(-days) %>%
spread(key = wildfire, value = cases) %>%
rename(WF_cases = WFperiod,
noWF_cases = nonWFperiod)
View(cases)
cases <- foo %>%
group_by(zip, wildfire) %>%
summarise(white = sum(white),
hispanic = sum(hispanic),
black = sum(black),
native_am = sum(native_am),
asian_pi = sum(asian_pi),
other = sum(other),
days = length(svc_from_dt)) %>%
gather(white, hispanic, black, native_am, asian_pi,other, key = race, value = cases) %>%
select(-days) %>%
spread(key = wildfire, value = cases) %>%
rename(WF_cases = WFperiod,
noWF_cases = nonWFperiod)
View(cases)
rates <- foo %>%
group_by(zip, wildfire) %>%
summarise(white = sum(white),
hispanic = sum(hispanic),
black = sum(black),
native_am = sum(native_am),
asian_pi = sum(asian_pi),
other = sum(other),
days = length(svc_from_dt)) %>%
gather(white, hispanic, black, native_am, asian_pi,other, key = race, value = cases) %>%
mutate(casesPerDay = ifelse(cases == 0, constant/days, cases/days)) %>%
select(-days) %>%
spread(key = wildfire, value = casesPerDay) %>%
rename(WF_rate = WFperiod,
noWF_rate = nonWFperiod)
View(rates)
rates <- foo %>%
group_by(zip, wildfire) %>%
summarise(white = sum(white),
hispanic = sum(hispanic),
black = sum(black),
native_am = sum(native_am),
asian_pi = sum(asian_pi),
other = sum(other),
days = length(svc_from_dt)) %>%
gather(white, hispanic, black, native_am, asian_pi,other, key = race, value = cases) %>%
mutate(casesPerDay = ifelse(cases == 0, constant/days, cases/days)) %>%
select(-days, -cases) %>%
spread(key = wildfire, value = casesPerDay) %>%
rename(WF_rate = WFperiod,
noWF_rate = nonWFperiod)
View(rates)
cases <- foo %>%
group_by(zip, wildfire) %>%
summarise(white = sum(white),
hispanic = sum(hispanic),
black = sum(black),
native_am = sum(native_am),
asian_pi = sum(asian_pi),
other = sum(other),
days = length(svc_from_dt)) %>%
gather(white, hispanic, black, native_am, asian_pi,other, key = race, value = cases) %>%
select(-days) %>%
spread(key = wildfire, value = cases) %>%
mutate(remove = ifelse(WFperiod == 0 & nonWFperiod == 0, "remove","keep")) %>%
rename(WF_cases = WFperiod,
noWF_cases = nonWFperiod)
View(cases)
merge(cases, rates)
RR_race <- merge(cases, rates)
View(RR_race)
RR_race <- merge(cases, rates) %>%
mutate(RateRatio = WF_rate/noWF_rate)
View(RR_race)
RR_race <- merge(cases, rates) %>%
mutate(RateRatio = WF_rate/noWF_rate,
ln_RateRatio = log(WF_rate/noWF_rate))
View(RR_race)
ggplot(RR_race, aes(x = ln_RateRatio, fill=race, alpha=0.7)) + geom_histogram(bins = 10)  + facet_grid(.~race) + guides(alpha=FALSE)
ggplot(RR_race, aes(x = ln_RateRatio, fill=race, alpha=0.7)) + geom_histogram(bins = 10)  + facet_grid(remove~race) + guides(alpha=FALSE)
RR_race %>% filter(remove == keep) %>%
ggplot(aes(x = ln_RateRatio, fill=race, alpha=0.7)) + geom_histogram(bins = 10)  + facet_grid(remove~race) + guides(alpha=FALSE)
RR_race %>% filter(remove == "keep") %>%
ggplot(aes(x = ln_RateRatio, fill=race, alpha=0.7)) + geom_histogram(bins = 10)  + facet_grid(remove~race) + guides(alpha=FALSE)
RR_race %>%
ggplot() + geom_boxplot(aes(x= race, y= ln_RateRatio))+ geom_jitter(aes(x= race, y= ln_RateRatio, color=race), alpha=0.2) + guides(color=FALSE)
ggplot(RR_race, aes(x = reorder(zip, ln_RateRatio), y = ln_RateRatio, color=race)) + geom_point() + coord_flip()
RR_race %>% filter(remove == "keep") %>%
ggplot(aes(x = ln_RateRatio, fill=race, alpha=0.7)) + geom_histogram(bins = 10)  + facet_grid(remove~race) + guides(alpha=FALSE)
RR_race %>%
filter(remove == "keep") %>%
ggplot() + geom_boxplot(aes(x= race, y= ln_RateRatio))+ geom_jitter(aes(x= race, y= ln_RateRatio, color=race), alpha=0.2) + guides(color=FALSE)
RR_race %>% filter(remove == "keep") %>%
ggplot(aes(x = ln_RateRatio, fill=race, alpha=0.7)) + geom_histogram(bins = 10)  + facet_grid(remove~race) + guides(alpha=FALSE)
RR_race %>%
ggplot() + geom_boxplot(aes(x= race, y= ln_RateRatio))+ geom_jitter(aes(x= race, y= ln_RateRatio, color=race), alpha=0.2) + guides(color=FALSE)
RR_race %>%
filter(remove == "keep") %>%
ggplot() + geom_boxplot(aes(x= race, y= ln_RateRatio))+ geom_jitter(aes(x= race, y= ln_RateRatio, color=race), alpha=0.2) + guides(color=FALSE)
shiny::runApp('GitHub/CHVIr/CHVIz')
